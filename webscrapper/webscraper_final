import os
import time
import random
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from webdriver_manager.chrome import ChromeDriverManager

# Se crea carpeta de descarga para almacenar el dataset
download_dir = os.path.join(os.getcwd(), "datamexico_csv")
os.makedirs(download_dir, exist_ok=True)

# Configuración de navegador
options = webdriver.ChromeOptions()
prefs = {
    "download.default_directory": download_dir,
    "download.prompt_for_download": False,
    "download.directory_upgrade": True,
    "safebrowsing.enabled": True
}
options.add_experimental_option("prefs", prefs)

# Inicia Chrome con webdriver-manager
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
wait = WebDriverWait(driver, 60)

# Paso 1: abrir Google (tiempos largos por CAPTCHA)
driver.get("https://www.google.com")
time.sleep(random.uniform(6, 9))

# Paso 2: buscar "DataMéxico" en Google
search_box = wait.until(EC.element_to_be_clickable((By.NAME, "q")))
for char in "DataMexico":
    search_box.send_keys(char)
    time.sleep(random.uniform(0.4, 0.7))
search_box.send_keys(Keys.ENTER)
time.sleep(random.uniform(8, 12))

# Paso 3: abrir Vizbuilder base
base_url = "https://www.economia.gob.mx/datamexico/es/vizbuilder"
driver.get(base_url)
time.sleep(random.uniform(10, 14))  # espera larga antes de Vizbuilder

# Paso 4: construcción de URL paso a paso y refresco de página
url = base_url

# Selección de dataset (cube)
url += "?cube=coneval_poverty"
driver.get(url)
time.sleep(3)

# Selección de idioma
url += "&locale=es"
driver.get(url)
time.sleep(3)

# Selección de filtros (años)
url += "&cuts[0]=Year,2015,2020"
driver.get(url)
time.sleep(3)

# Selección de drilldowns
url += "&drilldowns[0]=Year&drilldowns[1]=Geography.State"
driver.get(url)
time.sleep(3)

# Selección de medidas
url += "&measures[0]=Poverty"
url += "&measures[1]=Extreme+Poverty"
url += "&measures[2]=Educational+Backwardness"
url += "&measures[3]=Deprivation+Social+Security"
url += "&measures[4]=Population+with+at+least+3+Social+Lacks"
driver.get(url)
time.sleep(3)

print("URL final construido:", url)

# Paso 5: clic en botón "CSV" para descarga
csv_button = wait.until(EC.element_to_be_clickable((By.XPATH, "//span[contains(text(),'CSV')]")))
csv_button.click()

# Paso 6: espera de descarga de archivo y finalización del proceso
time.sleep(25)
driver.quit()

print(f"Archivo CSV descargado en la carpeta: {download_dir}")
